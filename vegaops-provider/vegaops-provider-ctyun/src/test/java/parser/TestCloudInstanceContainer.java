package parser;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.parser.Feature;
import lombok.SneakyThrows;
import org.prophetech.hyperone.vegaops.engine.utils.FileUtils;
import org.junit.Test;
import org.prophetech.hyperone.vegaops.engine.model.CloudContainer;
import org.prophetech.hyperone.vegaops.engine.parser.ContainerParser;
import org.springframework.util.FileCopyUtils;

import java.io.InputStream;
import java.util.LinkedHashMap;

public class TestCloudInstanceContainer {
    @SneakyThrows
    @Test
    public  void testInstall() {
        InputStream inputStream = FileUtils.getResourceAsStream("parser/vegaopsInstanceContainer.json");
        String json = new String(FileCopyUtils.copyToByteArray(inputStream));
        LinkedHashMap source = JSON.parseObject(json, LinkedHashMap.class, Feature.OrderedField);
        CloudContainer container = new CloudContainer();
        container.readFormMap(source);
        ContainerParser.install(container);
        System.out.println(container.toJson());
    }
    @SneakyThrows
    @Test
    public void testUninstall(){
        String json = "{\"vendor\":\"ctyun\",\"containerOutput\":{\"instance-postpaid-1\":{\"image\":\"3af8a1ec-94a8-4e39-adef-7a9cedd93a44\",\"floatingIp\":\"\",\"memory\":\"\",\"created\":\"\",\"privateIp\":\"\",\"cpu\":\"\",\"flavor\":\"c2.medium\",\"payType\":\"PostPaid\",\"expireTime\":\"\",\"regionId\":\"cn-gzT\",\"success\":\"true\",\"vpcId\":\"f3d2f931-0279-4fe7-8362-fb7b0c7f83a8\",\"name\":\"vegaopstestz\",\"osType\":\"linux\",\"zoneId\":\"cn-gzTa\",\"securityGroups\":\"1ae92871-e385-4a29-9db6-05413cdeffa2\",\"id\":\"7791ca67-c2d8-4d99-b851-fd74a2f2f063\",\"vswithId\":\"4a8c0494-c640-4c05-bf81-3eb97b56760d\",\"status\":\"\"},\"vswitch-1\":{\"resVlanId\":\"4a8c0494-c640-4c05-bf81-3eb97b56760d\",\"primaryDns\":\"100.125.128.17\",\"success\":\"true\",\"vpcId\":\"f3d2f931-0279-4fe7-8362-fb7b0c7f83a8\",\"name\":\"fty-test1234\",\"cidr\":\"192.168.0.0/24\",\"secondaryDns\":\"114.114.114.114\",\"availabilityZone\":\"cn-gzTa\",\"gateway\":\"192.168.0.1\",\"status\":\"SUCCESS\"},\"vpc-1\":{\"name\":\"vegaopsTest123213\",\"cidr\":\"192.168.0.0/24\",\"success\":\"true\",\"vpcId\":\"f3d2f931-0279-4fe7-8362-fb7b0c7f83a8\",\"status\":\"SUCCESS\"}},\"nodeMap\":{\"instance-postpaid-1\":{\"action\":\"install\",\"componentId\":\"instance-postpaid-1\",\"dependency\":[\"vpc-1\",\"vswitch-1\"],\"dependencyNodes\":[\"vswitch-1\",\"vpc-1\"],\"nodeType\":\"instance\",\"output\":{\"image\":\"3af8a1ec-94a8-4e39-adef-7a9cedd93a44\",\"floatingIp\":\"\",\"memory\":\"\",\"created\":\"\",\"privateIp\":\"\",\"cpu\":\"\",\"flavor\":\"c2.medium\",\"payType\":\"PostPaid\",\"expireTime\":\"\",\"regionId\":\"cn-gzT\",\"success\":\"true\",\"vpcId\":\"f3d2f931-0279-4fe7-8362-fb7b0c7f83a8\",\"name\":\"vegaopstestz\",\"osType\":\"linux\",\"zoneId\":\"cn-gzTa\",\"securityGroups\":\"1ae92871-e385-4a29-9db6-05413cdeffa2\",\"id\":\"7791ca67-c2d8-4d99-b851-fd74a2f2f063\",\"vswithId\":\"4a8c0494-c640-4c05-bf81-3eb97b56760d\",\"status\":\"\"},\"vars\":{\"subnetId\":\"4a8c0494-c640-4c05-bf81-3eb97b56760d\",\"volumeType\":\"SATA\",\"adminPass\":\"Fu123456\",\"shareType\":\"PER\",\"volumeSize\":\"50\",\"securityGroupId\":\"1ae92871-e385-4a29-9db6-05413cdeffa2\",\"payType\":\"PostPaid\",\"publicIpId\":\"784992f5-441c-4c34-a499-99a951a98e49\",\"regionId\":\"cn-gzT\",\"vpcId\":\"f3d2f931-0279-4fe7-8362-fb7b0c7f83a8\",\"name\":\"vegaopstestz\",\"osType\":\"linux\",\"zoneId\":\"cn-gzTa\",\"flavorRef\":\"c2.medium\",\"imageRef\":\"3af8a1ec-94a8-4e39-adef-7a9cedd93a44\"}},\"vswitch-1\":{\"action\":\"install\",\"componentId\":\"vswitch-1\",\"dependency\":[\"vpc-1\"],\"dependencyNodes\":[\"vpc-1\"],\"nodeType\":\"vswitch\",\"output\":{\"resVlanId\":\"4a8c0494-c640-4c05-bf81-3eb97b56760d\",\"primaryDns\":\"100.125.128.17\",\"success\":\"true\",\"vpcId\":\"f3d2f931-0279-4fe7-8362-fb7b0c7f83a8\",\"name\":\"fty-test1234\",\"cidr\":\"192.168.0.0/24\",\"secondaryDns\":\"114.114.114.114\",\"availabilityZone\":\"cn-gzTa\",\"gateway\":\"192.168.0.1\",\"status\":\"SUCCESS\"},\"vars\":{\"dhcpEnable\":\"true\",\"regionId\":\"cn-gzT\",\"vpcId\":\"f3d2f931-0279-4fe7-8362-fb7b0c7f83a8\",\"name\":\"fty-test1234\",\"zoneId\":\"cn-gzTa\",\"cidr\":\"192.168.0.0/24\",\"gatewayIp\":\"192.168.0.1\"}},\"vpc-1\":{\"action\":\"install\",\"componentId\":\"vpc-1\",\"dependency\":[],\"dependencyNodes\":[],\"nodeType\":\"vpc\",\"output\":{\"name\":\"vegaopsTest123213\",\"cidr\":\"192.168.0.0/24\",\"success\":\"true\",\"vpcId\":\"f3d2f931-0279-4fe7-8362-fb7b0c7f83a8\",\"status\":\"SUCCESS\"},\"vars\":{\"name\":\"vegaopsTest123213\",\"cidr\":\"192.168.0.0/24\",\"regionId\":\"cn-gzT\"}}},\"nodes\":[{\"action\":\"install\",\"componentId\":\"instance-postpaid-1\",\"dependency\":[\"vpc-1\",\"vswitch-1\"],\"dependencyNodes\":[\"vswitch-1\",\"vpc-1\"],\"nodeType\":\"instance\",\"output\":{\"image\":\"3af8a1ec-94a8-4e39-adef-7a9cedd93a44\",\"floatingIp\":\"\",\"memory\":\"\",\"created\":\"\",\"privateIp\":\"\",\"cpu\":\"\",\"flavor\":\"c2.medium\",\"payType\":\"PostPaid\",\"expireTime\":\"\",\"regionId\":\"cn-gzT\",\"success\":\"true\",\"vpcId\":\"f3d2f931-0279-4fe7-8362-fb7b0c7f83a8\",\"name\":\"vegaopstestz\",\"osType\":\"linux\",\"zoneId\":\"cn-gzTa\",\"securityGroups\":\"1ae92871-e385-4a29-9db6-05413cdeffa2\",\"id\":\"7791ca67-c2d8-4d99-b851-fd74a2f2f063\",\"vswithId\":\"4a8c0494-c640-4c05-bf81-3eb97b56760d\",\"status\":\"\"},\"vars\":{\"subnetId\":\"4a8c0494-c640-4c05-bf81-3eb97b56760d\",\"volumeType\":\"SATA\",\"adminPass\":\"Fu123456\",\"shareType\":\"PER\",\"volumeSize\":\"50\",\"securityGroupId\":\"1ae92871-e385-4a29-9db6-05413cdeffa2\",\"payType\":\"PostPaid\",\"publicIpId\":\"784992f5-441c-4c34-a499-99a951a98e49\",\"regionId\":\"cn-gzT\",\"vpcId\":\"f3d2f931-0279-4fe7-8362-fb7b0c7f83a8\",\"name\":\"vegaopstestz\",\"osType\":\"linux\",\"zoneId\":\"cn-gzTa\",\"flavorRef\":\"c2.medium\",\"imageRef\":\"3af8a1ec-94a8-4e39-adef-7a9cedd93a44\"}},{\"action\":\"install\",\"componentId\":\"vpc-1\",\"dependency\":[],\"dependencyNodes\":[],\"nodeType\":\"vpc\",\"output\":{\"name\":\"vegaopsTest123213\",\"cidr\":\"192.168.0.0/24\",\"success\":\"true\",\"vpcId\":\"f3d2f931-0279-4fe7-8362-fb7b0c7f83a8\",\"status\":\"SUCCESS\"},\"vars\":{\"name\":\"vegaopsTest123213\",\"cidr\":\"192.168.0.0/24\",\"regionId\":\"cn-gzT\"}},{\"action\":\"install\",\"componentId\":\"vswitch-1\",\"dependency\":[\"vpc-1\"],\"dependencyNodes\":[\"vpc-1\"],\"nodeType\":\"vswitch\",\"output\":{\"resVlanId\":\"4a8c0494-c640-4c05-bf81-3eb97b56760d\",\"primaryDns\":\"100.125.128.17\",\"success\":\"true\",\"vpcId\":\"f3d2f931-0279-4fe7-8362-fb7b0c7f83a8\",\"name\":\"fty-test1234\",\"cidr\":\"192.168.0.0/24\",\"secondaryDns\":\"114.114.114.114\",\"availabilityZone\":\"cn-gzTa\",\"gateway\":\"192.168.0.1\",\"status\":\"SUCCESS\"},\"vars\":{\"dhcpEnable\":\"true\",\"regionId\":\"cn-gzT\",\"vpcId\":\"f3d2f931-0279-4fe7-8362-fb7b0c7f83a8\",\"name\":\"fty-test1234\",\"zoneId\":\"cn-gzTa\",\"cidr\":\"192.168.0.0/24\",\"gatewayIp\":\"192.168.0.1\"}}],\"resolveArrangement\":[\"vpc-1\",\"vswitch-1\",\"instance-postpaid-1\"],\"resolvedNodes\":[\"instance-postpaid-1\",\"vswitch-1\",\"vpc-1\"],\"success\":true,\"unresolvedNodes\":[],\"variables\":{\"zoneId\":\"cn-gzTa\",\"ctyunAccount\":{\"accessKey\":\"xxxxx\",\"secret\":\"xxxxx\"},\"regionId\":\"cn-gzT\"}}\n";
        CloudContainer container =JSON.parseObject(json,CloudContainer.class);
        ContainerParser.uninstall(container);
        System.out.println(container.getContainerOutput());
    }
}
