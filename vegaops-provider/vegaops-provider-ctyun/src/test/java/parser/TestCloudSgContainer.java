package parser;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.parser.Feature;
import lombok.SneakyThrows;
import org.prophetech.hyperone.vegaops.engine.utils.FileUtils;
import org.junit.Test;
import org.prophetech.hyperone.vegaops.engine.model.CloudContainer;
import org.prophetech.hyperone.vegaops.engine.parser.ContainerParser;
import org.springframework.util.FileCopyUtils;

import java.io.InputStream;
import java.util.LinkedHashMap;

public class TestCloudSgContainer {
    @SneakyThrows
    @Test
    public  void testInstall() {
        InputStream inputStream = FileUtils.getResourceAsStream("parser/vegaopsSgContainer.json");
        String json = new String(FileCopyUtils.copyToByteArray(inputStream));
        LinkedHashMap source = JSON.parseObject(json, LinkedHashMap.class, Feature.OrderedField);
        CloudContainer container = new CloudContainer();
        container.readFormMap(source);
        ContainerParser.install(container);
        System.out.println(container.toJson());
    }

    @SneakyThrows
    @Test
    public void testUninstall(){
        String json = "{\"vendor\":\"ctyun\",\"containerOutput\":{\"securityGroupRule-1\":{\"ethertype\":\"IPv4\",\"description\":\"\",\"portRangeMax\":\"\",\"message\":\"\",\"remoteIpPrefix\":\"0.0.0.0/0\",\"securityGroupRuleId\":\"106249e5-d341-4ffc-839c-2e28deed4a9e\",\"securityGroupId\":\"aa3d4c12-793d-4d36-b474-5d92b092731c\",\"createdAt\":\"2020-04-13T08:56:29\",\"protocol\":\"\",\"portRangeMin\":\"\",\"success\":\"true\",\"tenantId\":\"07d47690478295e42f4ac010faa224da\",\"direction\":\"egress\",\"updatedAt\":\"2020-04-13T08:56:29\"},\"securityGroup-1\":{\"name\":\"vegaopssgTest-011\",\"securityGroupId\":\"aa3d4c12-793d-4d36-b474-5d92b092731c\",\"description\":\"3819d846-20bc-4159-bb7b-b434334707bd\",\"success\":\"true\",\"resultType\":\"list:securityGroupRules\",\"securityGroupRules\":[{\"cidr\":\"\",\"description\":\"\",\"direction\":\"egress\",\"ipv6Cidr\":\"\",\"policy\":\"\",\"portEnd\":\"\",\"portStart\":\"\",\"protocol\":\"\",\"providerId\":\"bcd351c9-1318-4f4f-8184-b07ec30185fb\",\"regionId\":\"\",\"remoteSg\":\"\",\"sgId\":\"aa3d4c12-793d-4d36-b474-5d92b092731c\",\"zoneId\":\"\"},{\"cidr\":\"\",\"description\":\"\",\"direction\":\"egress\",\"ipv6Cidr\":\"\",\"policy\":\"\",\"portEnd\":\"\",\"portStart\":\"\",\"protocol\":\"\",\"providerId\":\"b4ed330d-d7ec-43b1-9326-5d10398702de\",\"regionId\":\"\",\"remoteSg\":\"\",\"sgId\":\"aa3d4c12-793d-4d36-b474-5d92b092731c\",\"zoneId\":\"\"},{\"cidr\":\"\",\"description\":\"\",\"direction\":\"ingress\",\"ipv6Cidr\":\"\",\"policy\":\"\",\"portEnd\":\"\",\"portStart\":\"\",\"protocol\":\"\",\"providerId\":\"c48ea267-ec79-4f14-91b2-da3cd579fa7b\",\"regionId\":\"\",\"remoteSg\":\"aa3d4c12-793d-4d36-b474-5d92b092731c\",\"sgId\":\"aa3d4c12-793d-4d36-b474-5d92b092731c\",\"zoneId\":\"\"},{\"cidr\":\"\",\"description\":\"\",\"direction\":\"ingress\",\"ipv6Cidr\":\"\",\"policy\":\"\",\"portEnd\":\"\",\"portStart\":\"\",\"protocol\":\"\",\"providerId\":\"168d6fb3-c601-4ea9-ac06-d1220ea87a5e\",\"regionId\":\"\",\"remoteSg\":\"aa3d4c12-793d-4d36-b474-5d92b092731c\",\"sgId\":\"aa3d4c12-793d-4d36-b474-5d92b092731c\",\"zoneId\":\"\"}]}},\"nodeMap\":{\"securityGroupRule-1\":{\"action\":\"install\",\"componentId\":\"securityGroupRule-1\",\"dependency\":[\"securityGroup-1\"],\"dependencyNodes\":[\"securityGroup-1\"],\"nodeType\":\"securityGroupRule\",\"output\":{\"ethertype\":\"IPv4\",\"description\":\"\",\"portRangeMax\":\"\",\"message\":\"\",\"remoteIpPrefix\":\"0.0.0.0/0\",\"securityGroupRuleId\":\"106249e5-d341-4ffc-839c-2e28deed4a9e\",\"securityGroupId\":\"aa3d4c12-793d-4d36-b474-5d92b092731c\",\"createdAt\":\"2020-04-13T08:56:29\",\"protocol\":\"\",\"portRangeMin\":\"\",\"success\":\"true\",\"tenantId\":\"07d47690478295e42f4ac010faa224da\",\"direction\":\"egress\",\"updatedAt\":\"2020-04-13T08:56:29\"},\"vars\":{\"securityGroupId\":\"aa3d4c12-793d-4d36-b474-5d92b092731c\",\"protocol\":\"\",\"portRangeMin\":\"\",\"remoteGroupId\":\"\",\"regionId\":\"cn-gzT\",\"ethertype\":\"IPv4\",\"portRangeMax\":\"\",\"remoteIpPrefix\":\"\",\"direction\":\"egress\"}},\"securityGroup-1\":{\"action\":\"install\",\"componentId\":\"securityGroup-1\",\"dependency\":[],\"dependencyNodes\":[],\"nodeType\":\"securityGroup\",\"output\":{\"name\":\"vegaopssgTest-011\",\"securityGroupId\":\"aa3d4c12-793d-4d36-b474-5d92b092731c\",\"description\":\"3819d846-20bc-4159-bb7b-b434334707bd\",\"success\":\"true\",\"resultType\":\"list:securityGroupRules\",\"securityGroupRules\":[{\"cidr\":\"\",\"description\":\"\",\"direction\":\"egress\",\"ipv6Cidr\":\"\",\"policy\":\"\",\"portEnd\":\"\",\"portStart\":\"\",\"protocol\":\"\",\"providerId\":\"bcd351c9-1318-4f4f-8184-b07ec30185fb\",\"regionId\":\"\",\"remoteSg\":\"\",\"sgId\":\"aa3d4c12-793d-4d36-b474-5d92b092731c\",\"zoneId\":\"\"},{\"cidr\":\"\",\"description\":\"\",\"direction\":\"egress\",\"ipv6Cidr\":\"\",\"policy\":\"\",\"portEnd\":\"\",\"portStart\":\"\",\"protocol\":\"\",\"providerId\":\"b4ed330d-d7ec-43b1-9326-5d10398702de\",\"regionId\":\"\",\"remoteSg\":\"\",\"sgId\":\"aa3d4c12-793d-4d36-b474-5d92b092731c\",\"zoneId\":\"\"},{\"cidr\":\"\",\"description\":\"\",\"direction\":\"ingress\",\"ipv6Cidr\":\"\",\"policy\":\"\",\"portEnd\":\"\",\"portStart\":\"\",\"protocol\":\"\",\"providerId\":\"c48ea267-ec79-4f14-91b2-da3cd579fa7b\",\"regionId\":\"\",\"remoteSg\":\"aa3d4c12-793d-4d36-b474-5d92b092731c\",\"sgId\":\"aa3d4c12-793d-4d36-b474-5d92b092731c\",\"zoneId\":\"\"},{\"cidr\":\"\",\"description\":\"\",\"direction\":\"ingress\",\"ipv6Cidr\":\"\",\"policy\":\"\",\"portEnd\":\"\",\"portStart\":\"\",\"protocol\":\"\",\"providerId\":\"168d6fb3-c601-4ea9-ac06-d1220ea87a5e\",\"regionId\":\"\",\"remoteSg\":\"aa3d4c12-793d-4d36-b474-5d92b092731c\",\"sgId\":\"aa3d4c12-793d-4d36-b474-5d92b092731c\",\"zoneId\":\"\"}]},\"vars\":{\"name\":\"vegaopssgTest-011\",\"regionId\":\"cn-gzT\",\"vpcId\":\"3819d846-20bc-4159-bb7b-b434334707bd\"}}},\"nodes\":[{\"action\":\"install\",\"componentId\":\"securityGroup-1\",\"dependency\":[],\"dependencyNodes\":[],\"nodeType\":\"securityGroup\",\"output\":{\"name\":\"vegaopssgTest-011\",\"securityGroupId\":\"aa3d4c12-793d-4d36-b474-5d92b092731c\",\"description\":\"3819d846-20bc-4159-bb7b-b434334707bd\",\"success\":\"true\",\"resultType\":\"list:securityGroupRules\",\"securityGroupRules\":[{\"cidr\":\"\",\"description\":\"\",\"direction\":\"egress\",\"ipv6Cidr\":\"\",\"policy\":\"\",\"portEnd\":\"\",\"portStart\":\"\",\"protocol\":\"\",\"providerId\":\"bcd351c9-1318-4f4f-8184-b07ec30185fb\",\"regionId\":\"\",\"remoteSg\":\"\",\"sgId\":\"aa3d4c12-793d-4d36-b474-5d92b092731c\",\"zoneId\":\"\"},{\"cidr\":\"\",\"description\":\"\",\"direction\":\"egress\",\"ipv6Cidr\":\"\",\"policy\":\"\",\"portEnd\":\"\",\"portStart\":\"\",\"protocol\":\"\",\"providerId\":\"b4ed330d-d7ec-43b1-9326-5d10398702de\",\"regionId\":\"\",\"remoteSg\":\"\",\"sgId\":\"aa3d4c12-793d-4d36-b474-5d92b092731c\",\"zoneId\":\"\"},{\"cidr\":\"\",\"description\":\"\",\"direction\":\"ingress\",\"ipv6Cidr\":\"\",\"policy\":\"\",\"portEnd\":\"\",\"portStart\":\"\",\"protocol\":\"\",\"providerId\":\"c48ea267-ec79-4f14-91b2-da3cd579fa7b\",\"regionId\":\"\",\"remoteSg\":\"aa3d4c12-793d-4d36-b474-5d92b092731c\",\"sgId\":\"aa3d4c12-793d-4d36-b474-5d92b092731c\",\"zoneId\":\"\"},{\"cidr\":\"\",\"description\":\"\",\"direction\":\"ingress\",\"ipv6Cidr\":\"\",\"policy\":\"\",\"portEnd\":\"\",\"portStart\":\"\",\"protocol\":\"\",\"providerId\":\"168d6fb3-c601-4ea9-ac06-d1220ea87a5e\",\"regionId\":\"\",\"remoteSg\":\"aa3d4c12-793d-4d36-b474-5d92b092731c\",\"sgId\":\"aa3d4c12-793d-4d36-b474-5d92b092731c\",\"zoneId\":\"\"}]},\"vars\":{\"name\":\"vegaopssgTest-011\",\"regionId\":\"cn-gzT\",\"vpcId\":\"3819d846-20bc-4159-bb7b-b434334707bd\"}},{\"action\":\"install\",\"componentId\":\"securityGroupRule-1\",\"dependency\":[\"securityGroup-1\"],\"dependencyNodes\":[\"securityGroup-1\"],\"nodeType\":\"securityGroupRule\",\"output\":{\"ethertype\":\"IPv4\",\"description\":\"\",\"portRangeMax\":\"\",\"message\":\"\",\"remoteIpPrefix\":\"0.0.0.0/0\",\"securityGroupRuleId\":\"106249e5-d341-4ffc-839c-2e28deed4a9e\",\"securityGroupId\":\"aa3d4c12-793d-4d36-b474-5d92b092731c\",\"createdAt\":\"2020-04-13T08:56:29\",\"protocol\":\"\",\"portRangeMin\":\"\",\"success\":\"true\",\"tenantId\":\"07d47690478295e42f4ac010faa224da\",\"direction\":\"egress\",\"updatedAt\":\"2020-04-13T08:56:29\"},\"vars\":{\"securityGroupId\":\"aa3d4c12-793d-4d36-b474-5d92b092731c\",\"protocol\":\"\",\"portRangeMin\":\"\",\"remoteGroupId\":\"\",\"regionId\":\"cn-gzT\",\"ethertype\":\"IPv4\",\"portRangeMax\":\"\",\"remoteIpPrefix\":\"\",\"direction\":\"egress\"}}],\"resolveArrangement\":[\"securityGroup-1\",\"securityGroupRule-1\"],\"resolvedNodes\":[\"securityGroupRule-1\",\"securityGroup-1\"],\"success\":true,\"unresolvedNodes\":[],\"variables\":{\"regionId\":\"cn-gzT\",\"ctyunAccount\":{\"accessKey\":\"xxxxx\",\"secret\":\"xxxxx\"}}}";
        CloudContainer container =JSON.parseObject(json,CloudContainer.class);
        ContainerParser.uninstall(container);
        System.out.println(container.getContainerOutput());
    }

}
